// Enhanced Clash Config Script
// For Clash Verge Rev (Version ≥ 17.2) & Mihomo-Party (Version ≥ 1.5.10)
// Last Update: 2025-03-19

const ruleProviderCommon = {
  "type": "http",
  "format": "text",
  "interval": 86400
};

const groupBaseOption = {
  "interval": 86400,
  "url": "https://cp.cloudflare.com/generate_204",
  "max-failed-times": 3,
};

const standardProxies = ["手动切换", "🇭🇰 香港", "🇺🇸 美国", "🇸🇬 狮城", "🇯🇵 日本", "🇹🇼 台湾", "DIRECT"];

function main(config) {
  if (!config || typeof config !== 'object') {
    throw new Error("Invalid configuration file");
  }
  
  const proxyCount = config?.proxies?.length ?? 0;
  const proxyProviderCount =
    typeof config?.["proxy-providers"] === "object" ? Object.keys(config["proxy-providers"]).length : 0;
  if (proxyCount === 0 && proxyProviderCount === 0) {
    throw new Error("No proxies found in configuration");
  }

  config["mixed-port"] = 7890;
  config["tcp-concurrent"] = true;
  config["allow-lan"] = true;
  config["bind-address"] = "*";
  config["mode"] = "rule";
  config["ipv6"] = false;
  config["log-level"] = "info";
  config["unified-delay"] = true;
  config["find-process-mode"] = "strict";
  config["global-client-fingerprint"] = "chrome";
  config["profile"] = {
    "store-selected": true,
    "store-fake-ip": true
  };
  
  config["dns"] = {
    "enable": true,
    "listen": "0.0.0.0:1053",
    "ipv6": false,
    "enhanced-mode": "fake-ip",
    "fake-ip-range": "198.18.0.1/16",
    "fake-ip-filter": [
      "*", "+.lan", "+.local", "+.direct", 
      "+.msftconnecttest.com", "+.msftncsi.com",
      "+.networkcheck.kde.org", "+.stun.*.*", 
      "+.stun.*.*.*", "+.stun.*.*.*.*"
    ],
    "nameserver": [
      "https://dns.cloudflare.com/dns-query",
      "https://doh.opendns.com/dns-query",
      "https://dns.google/dns-query",
      "223.5.5.5",
      "119.29.29.29"
    ],
    "fallback": [
      "https://dns.cloudflare.com/dns-query",
      "https://doh.opendns.com/dns-query",
      "https://dns.google/dns-query"
    ],
    "fallback-filter": {
      "geoip": true,
      "geoip-code": "CN",
      "ipcidr": [
        "240.0.0.0/4",
        "127.0.0.1/8",
        "0.0.0.0/32"
      ]
    }
  };

  config["geodata-mode"] = true;
  config["geox-url"] = {
    "geoip": "https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/geoip.dat",
    "geosite": "https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/geosite.dat",
    "mmdb": "https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/country.mmdb",
    "asn": "https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/asn.mmdb"
  };

  config["sniffer"] = {
    "enable": true,
    "parse-pure-ip": true,
    "sniff": {
      "TLS": {
        "ports": [443, 8443]
      },
      "HTTP": {
        "ports": [80, 8080, 8880],
        "override-destination": true
      },
      "QUIC": {
        "ports": [443, 8443]
      }
    }
  };

  config["tun"] = {
    "enable": true,
    "stack": "mixed",
    "dns-hijack": ["any:53"],
    "auto-route": true,
    "auto-detect-interface": true
  };

  config["proxy-groups"] = [
    {
      ...groupBaseOption,
      "name": "手动切换",
      "type": "select",
      "proxies": ["🇭🇰 香港", "🇺🇸 美国", "🇸🇬 狮城", "🇯🇵 日本", "🇹🇼 台湾", "DIRECT"],
      "include-all": true
    },
    {
      ...groupBaseOption,
      "name": "国外网站",
      "type": "select",
      "proxies": standardProxies
    },
    {
      ...groupBaseOption,
      "name": "国际媒体",
      "type": "select",
      "proxies": standardProxies
    },
    {
      ...groupBaseOption,
      "name": "苹果服务",
      "type": "select",
      "proxies": ["DIRECT", ...standardProxies.filter(item => item !== "DIRECT")]
    },
    {
      ...groupBaseOption,
      "name": "微软服务",
      "type": "select",
      "proxies": ["DIRECT", ...standardProxies.filter(item => item !== "DIRECT")]
    },
    {
      ...groupBaseOption,
      "name": "GitHub",
      "type": "select",
      "proxies": standardProxies
    },
    {
      ...groupBaseOption,
      "name": "谷歌服务",
      "type": "select",
      "proxies": standardProxies
    },
    {
      ...groupBaseOption,
      "name": "YouTube",
      "type": "select",
      "proxies": standardProxies
    },
    {
      ...groupBaseOption,
      "name": "Netflix",
      "type": "select",
      "proxies": standardProxies
    },
    {
      ...groupBaseOption,
      "name": "Disney+",
      "type": "select",
      "proxies": standardProxies
    },
    {
      ...groupBaseOption,
      "name": "PayPal",
      "type": "select",
      "proxies": standardProxies
    },
    {
      ...groupBaseOption,
      "name": "Telegram",
      "type": "select",
      "proxies": standardProxies
    },
    {
      ...groupBaseOption,
      "name": "AI",
      "type": "select",
      "proxies": standardProxies
    },
    {
      ...groupBaseOption,
      "name": "Spotify",
      "type": "select",
      "proxies": standardProxies
    },
    {
      ...groupBaseOption,
      "name": "动画疯",
      "type": "select",
      "proxies": standardProxies
    },
    {
      ...groupBaseOption,
      "name": "Viu",
      "type": "select",
      "proxies": standardProxies
    },
    {
      ...groupBaseOption,
      "name": "HBO",
      "type": "select",
      "proxies": standardProxies
    },
    {
      ...groupBaseOption,
      "name": "兜底分流",
      "type": "select",
      "proxies": ["手动切换", "DIRECT", "🇭🇰 香港", "🇺🇸 美国", "🇸🇬 狮城", "🇯🇵 日本", "🇹🇼 台湾"]
    },
    {
      ...groupBaseOption,
      "name": "🇭🇰 香港",
      "type": "url-test",
      "tolerance": 50,
      "include-all": true,
      "filter": "(?i)🇭🇰|香港|港|hk|hong|kong",
      "icon": ""
    },
    {
      ...groupBaseOption,
      "name": "🇺🇸 美国",
      "type": "url-test",
      "tolerance": 100,
      "include-all": true,
      "filter": "(?i)🇺🇸|美|美国|us|united states|america",
      "icon": ""
    },
    {
      ...groupBaseOption,
      "name": "🇸🇬 狮城",
      "type": "url-test",
      "tolerance": 50,
      "include-all": true,
      "filter": "(?i)🇸🇬|新加坡|坡|狮城|sg|singapore",
      "icon": ""
    },
    {
      ...groupBaseOption,
      "name": "🇯🇵 日本",
      "type": "url-test",
      "tolerance": 50,
      "include-all": true,
      "filter": "(?i)🇯🇵|日本|jp|japan",
      "icon": ""
    },
    {
      ...groupBaseOption,
      "name": "🇹🇼 台湾",
      "type": "url-test",
      "tolerance": 50,
      "include-all": true,
      "filter": "(?i)🇹🇼|台|台湾|tw|taiwan",
      "icon": ""
    }
  ];

  config["rule-providers"] = {
    "广告拦截": {
      ...ruleProviderCommon,
      "behavior": "domain",
      "url": "https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/reject.txt",
      "path": "./rules/reject.yaml"
    },
    "苹果服务": {
      ...ruleProviderCommon,
      "behavior": "domain",
      "url": "https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/apple.txt",
      "path": "./rules/apple.yaml"
    },
    "谷歌服务": {
      ...ruleProviderCommon,
      "behavior": "domain",
      "url": "https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/google.txt",
      "path": "./rules/google.yaml"
    },
    "微软服务": {
      ...ruleProviderCommon,
      "behavior": "domain",
      "url": "https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/microsoft.txt",
      "path": "./rules/microsoft.yaml"
    },
    "电报服务": {
      ...ruleProviderCommon,
      "behavior": "domain",
      "url": "https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/telegramcidr.txt",
      "path": "./rules/telegramcidr.yaml"
    },
    "GitHub": {
      ...ruleProviderCommon,
      "behavior": "domain",
      "url": "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/GitHub/GitHub.yaml",
      "path": "./rules/github.yaml"
    },
    "YouTube": {
      ...ruleProviderCommon,
      "behavior": "classical",
      "url": "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/YouTube/YouTube.yaml",
      "path": "./rules/youtube.yaml"
    },
    "Netflix": {
      ...ruleProviderCommon,
      "behavior": "classical",
      "url": "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Netflix/Netflix.yaml",
      "path": "./rules/netflix.yaml"
    },
    "Disney": {
      ...ruleProviderCommon,
      "behavior": "classical",
      "url": "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Disney/Disney.yaml",
      "path": "./rules/disney.yaml"
    },
    "PayPal": {
      ...ruleProviderCommon,
      "behavior": "classical",
      "url": "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/PayPal/PayPal.yaml",
      "path": "./rules/paypal.yaml"
    },
    "Viu": {
      ...ruleProviderCommon,
      "behavior": "classical",
      "url": "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Viu/Viu.yaml",
      "path": "./rules/viu.yaml"
    },
    "AI": {
      ...ruleProviderCommon,
      "behavior": "classical",
      "url": "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/OpenAI/OpenAI.yaml",
      "path": "./rules/ai.yaml"
    },
    "动画疯": {
      ...ruleProviderCommon,
      "behavior": "classical",
      "url": "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Bahamut/Bahamut.yaml",
      "path": "./rules/bahamut.yaml"
    },
    "Spotify": {
      ...ruleProviderCommon,
      "behavior": "classical",
      "url": "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Spotify/Spotify.yaml",
      "path": "./rules/spotify.yaml"
    },
    "HBO": {
      ...ruleProviderCommon,
      "behavior": "classical",
      "url": "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/HBO/HBO.yaml",
      "path": "./rules/hbo.yaml"
    },
    "国外网站": {
      ...ruleProviderCommon,
      "behavior": "domain",
      "url": "https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/proxy.txt",
      "path": "./rules/proxy.yaml"
    },
    "直连网站": {
      ...ruleProviderCommon,
      "behavior": "domain",
      "url": "https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/direct.txt",
      "path": "./rules/direct.yaml"
    },
    "私有网络": {
      ...ruleProviderCommon,
      "behavior": "domain",
      "url": "https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/private.txt",
      "path": "./rules/private.yaml"
    },
    "局域网": {
      ...ruleProviderCommon,
      "behavior": "classical",
      "url": "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Lan/Lan.yaml",
      "path": "./rules/lan.yaml"
    }
  };

  config["rules"] = [
    "DOMAIN-SUFFIX,local,DIRECT",
    "IP-CIDR,127.0.0.0/8,DIRECT",
    "IP-CIDR,172.16.0.0/12,DIRECT",
    "IP-CIDR,192.168.0.0/16,DIRECT",
    "IP-CIDR,10.0.0.0/8,DIRECT",
    "IP-CIDR,17.0.0.0/8,DIRECT",
    "IP-CIDR,100.64.0.0/10,DIRECT",
    "IP-CIDR,224.0.0.0/4,DIRECT",
    
    "DOMAIN-SUFFIX,generativelanguage.googleapis.com,AI",
    "DOMAIN-SUFFIX,replicate.com,AI",
    "DOMAIN-SUFFIX,huggingface.co,AI",
    "DOMAIN-SUFFIX,cohere.ai,AI",
    "DOMAIN-SUFFIX,stability.ai,AI",
    "DOMAIN-SUFFIX,claude.ai,AI",
    "DOMAIN-SUFFIX,anthropic.com,AI",
    "DOMAIN-SUFFIX,perplexity.ai,AI",
    
    "RULE-SET,广告拦截,REJECT",
    
    "RULE-SET,苹果服务,苹果服务",
    "RULE-SET,谷歌服务,谷歌服务",
    "RULE-SET,微软服务,微软服务",
    "RULE-SET,电报服务,Telegram",
    "RULE-SET,GitHub,GitHub",
    "RULE-SET,YouTube,YouTube",
    "RULE-SET,Netflix,Netflix",
    "RULE-SET,Disney,Disney+",
    "RULE-SET,PayPal,PayPal",
    "RULE-SET,Viu,Viu",
    "RULE-SET,AI,AI",
    "RULE-SET,动画疯,动画疯",
    "RULE-SET,Spotify,Spotify",
    "RULE-SET,HBO,HBO",
    
    "RULE-SET,直连网站,DIRECT",
    "RULE-SET,私有网络,DIRECT",
    "RULE-SET,局域网,DIRECT",
    
    "RULE-SET,国外网站,国外网站",
    
    "GEOIP,CN,DIRECT",
    "MATCH,兜底分流"
  ];

  return config;
}
